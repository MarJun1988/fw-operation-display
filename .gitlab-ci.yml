stages:
  - test
  - build
  - publish
  - deploy

variables:
  VERSION: ${CI_COMMIT_TAG:-2.0.0-${CI_COMMIT_SHORT_SHA}}
  IMAGE_BACKEND: "$CI_REGISTRY_IMAGE/backend"
  IMAGE_FRONTEND: "$CI_REGISTRY_IMAGE/frontend"
  DOCKER_TLS_CERTDIR: ""
  DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

# =========================
# ðŸ§ª TEST
# =========================

backend_test:
  stage: test
  image: node:20
  script:
    - cd backend
    - npm ci
    - npm run lint
  tags:
    - docker

frontend_test:
  stage: test
  image: node:20
  script:
    - cd frontend
    - npm ci
    - npm run lint
  tags:
    - docker

# =========================
# ðŸ—ï¸ BUILD (optional, Artefakte)
# =========================

build_backend:
  stage: build
  image: node:20
  script:
    - cd backend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - backend/dist
  tags:
    - docker

build_frontend:
  stage: build
  image: node:20
  script:
    - cd frontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/dist
  tags:
    - docker

# =========================
# ðŸ³ PUBLISH DOCKER IMAGES
# =========================

publish_backend:
  stage: publish
  image: docker:24
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker buildx create --name ci-builder --driver docker-container --use || docker buildx use ci-builder
    - docker buildx inspect --bootstrap
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION="$CI_COMMIT_TAG"
      else
        VERSION="2.0.0-$CI_COMMIT_SHORT_SHA"
      fi
      echo "Building backend version: $VERSION"
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        -f backend/Dockerfile.prod \
        -t $IMAGE_BACKEND:latest \
        -t $IMAGE_BACKEND:$VERSION \
        --push \
        ./backend
  tags:
    - docker

publish_frontend:
  stage: publish
  image: docker:24
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker buildx create --name ci-builder --driver docker-container --use || docker buildx use ci-builder
    - docker buildx inspect --bootstrap
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION="$CI_COMMIT_TAG"
      else
        VERSION="2.0.0-$CI_COMMIT_SHORT_SHA"
      fi
      echo "Building frontend version: $VERSION"
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        -f frontend/Dockerfile.prod \
        -t $IMAGE_FRONTEND:latest \
        -t $IMAGE_FRONTEND:$VERSION \
        --push \
        ./frontend
  tags:
    - docker

# =========================
# ðŸš€ DEPLOY (SSH)
# =========================
#        echo "ðŸ”„ Sync repository"
#        git fetch origin
#        git checkout testing
#        git reset --hard origin/testing

deploy_to_test_system:
  stage: deploy
  image: docker:24
  rules:
    - if: '$CI_COMMIT_BRANCH == "testing"'
  script:
    - echo "$TEST_SYSTEM_SSH_PRIVATE_KEY" | tr -d '\r' > /tmp/key.pem
    - chmod 600 /tmp/key.pem
    - |
      ssh -o StrictHostKeyChecking=no -i /tmp/key.pem $TEST_SYSTEM_USER@$TEST_SYSTEM_HOST << 'EOF'
        cd /opt/fw-operation-display &&
      
        echo "ðŸ³ Pull images"
        docker compose -f docker-compose.prod.yml pull &&
        echo "ðŸš€ Start containers"
        docker compose -f docker-compose.prod.yml up -d --build
      
        echo "â³ Waiting for containers to become healthy..."

        for i in {1..30}; do
          unhealthy=$(docker ps --filter "health=unhealthy" --format "{{.Names}}")
          starting=$(docker ps --filter "health=starting" --format "{{.Names}}")

          if [ -z "$unhealthy" ] && [ -z "$starting" ]; then
            echo "âœ… All containers are healthy"
            exit 0
          fi

          echo "Waiting... ($i/30)"
          sleep 5
        done

        echo "âŒ Containers did not become healthy in time"
        docker ps
        exit 1
      EOF
  tags:
    - docker

deploy_to_prod_system_lxc:
  stage: deploy
  image: docker:24
  rules:
    - if: '$CI_COMMIT_BRANCH == "developer"'
  script:
    - echo "DEV_USER=$PROD_LXC_SYSTEM_USER"
    - echo "DEV_HOST=$PROD_LXC_SYSTEM_HOST"
    - echo "$PROD_LXC_SYSTEM_SSH_PRIVATE_KEY" | tr -d '\r' > /tmp/key.pem
    - chmod 600 /tmp/key.pem
    - |
      ssh -o StrictHostKeyChecking=no -i /tmp/key.pem $PROD_LXC_SYSTEM_USER@$PROD_LXC_SYSTEM_HOST << 'EOF'
        cd /opt/fw-operation-display &&
        docker compose -f docker-compose.prod.yml pull &&
        docker compose -f docker-compose.prod.yml up -d --build
      
        echo "â³ Waiting for containers to become healthy..."

        for i in {1..30}; do
          unhealthy=$(docker ps --filter "health=unhealthy" --format "{{.Names}}")
          starting=$(docker ps --filter "health=starting" --format "{{.Names}}")

          if [ -z "$unhealthy" ] && [ -z "$starting" ]; then
            echo "âœ… All containers are healthy"
            exit 0
          fi

          echo "Waiting... ($i/30)"
          sleep 5
        done

        echo "âŒ Containers did not become healthy in time"
        docker ps
        exit 1
      EOF
  tags:
    - docker

deploy_to_prod_ndw_system_raspberry:
  stage: deploy
  image: docker:24
  only:
    - tags
  script:
    - echo "$PROD_NDW_RASPBERRY_SYSTEM_SSH_PRIVATE_KEY" | tr -d '\r' > /tmp/key.pem
    - chmod 600 /tmp/key.pem
    - |
      ssh -o StrictHostKeyChecking=no -i /tmp/key.pem $PROD_NDW_RASPBERRY_SYSTEM_USER@$PROD_NDW_RASPBERRY_SYSTEM_HOST << 'EOF'
        cd /opt/fw-operation-display &&
        docker compose -f docker-compose.prod.yml pull &&
        docker compose -f docker-compose.prod.yml up -d --build
      
        echo "â³ Waiting for containers to become healthy..."

        for i in {1..30}; do
          unhealthy=$(docker ps --filter "health=unhealthy" --format "{{.Names}}")
          starting=$(docker ps --filter "health=starting" --format "{{.Names}}")

          if [ -z "$unhealthy" ] && [ -z "$starting" ]; then
            echo "âœ… All containers are healthy"
            exit 0
          fi

          echo "Waiting... ($i/30)"
          sleep 10
        done

        echo "âŒ Containers did not become healthy in time"
        docker ps
        exit 1
      EOF
  tags:
    - docker

deploy_to_prod_liwa_system_raspberry:
  stage: deploy
  image: docker:24
  only:
    - tags
  script:
    - echo "$PROD_LIWA_RASPBERRY_SYSTEM_SSH_PRIVATE_KEY" | tr -d '\r' > /tmp/key.pem
    - chmod 600 /tmp/key.pem
    - |
      ssh -o StrictHostKeyChecking=no -i /tmp/key.pem $PROD_LIWA_RASPBERRY_SYSTEM_USER@$PROD_LIWA_RASPBERRY_SYSTEM_HOST << 'EOF'
        cd /opt/fw-operation-display &&
        docker compose -f docker-compose.prod.yml pull &&
        docker compose -f docker-compose.prod.yml up -d --build
      
        echo "â³ Waiting for containers to become healthy..."

        for i in {1..30}; do
          unhealthy=$(docker ps --filter "health=unhealthy" --format "{{.Names}}")
          starting=$(docker ps --filter "health=starting" --format "{{.Names}}")

          if [ -z "$unhealthy" ] && [ -z "$starting" ]; then
            echo "âœ… All containers are healthy"
            exit 0
          fi

          echo "Waiting... ($i/30)"
          sleep 10
        done

        echo "âŒ Containers did not become healthy in time"
        docker ps
        exit 1
      EOF
  tags:
    - docker