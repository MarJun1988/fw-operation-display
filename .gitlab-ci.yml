stages:
  - build
  - quality
  - test
  - cleanup

variables:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_DATABASE: fw-operation-display_test

default:
  image: registry.gitlab.com/marjun1988/fw-operation-display/php-ci:latest
  services:
    - name: mysql:8.0
      alias: db

# ===================================
# Build: Composer + NPM
# ===================================
build_app:
  stage: build
  script:
    - cd web-app
    - composer install --no-interaction --prefer-dist --no-scripts
    - npm install
    - npm run build
  artifacts:
    paths:
      - web-app/vendor
      - web-app/node_modules
      - web-app/public/build
    expire_in: 1h

# ===================================
# Code Quality
# ===================================
phpstan:
  stage: quality
  script:
    - cd web-app
    - composer phpstan
  allow_failure: true

# ===================================
# Tests inkl. Fixtures
# ===================================
phpunit:
  stage: test
  services:
    - name: mysql:8.0
      alias: db
  variables:
    DATABASE_URL: "mysql://root:root@db:3306/fw-operation-display"
    APP_ENV: test
  before_script:
    - cd web-app
    - cp .env.test .env
    # Warten bis MySQL verf√ºgbar
#    - until nc -z db 3306; do echo "Warte auf MySQL..."; sleep 2; done
  script:
    - composer test
  artifacts:
    reports:
      junit: web-app/build/report.xml
    expire_in: 1h
  allow_failure: true

# ===================================
# Cleanup
# ===================================
cleanup:
  stage: cleanup
  script:
    #- docker system prune -f
    - echo "Clean-Up"
  when: always