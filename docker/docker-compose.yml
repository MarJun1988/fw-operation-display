services:
  # Datenbank
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: supersecret
      MYSQL_DATABASE: fw-operation-display
      MYSQL_USER: web-app
      MYSQL_PASSWORD: feuerwehr112
    volumes:
      - "./db_data:/var/lib/mysql"
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
    restart: always
  # Container um PHP Dateien ausfÃ¼hren zu kÃ¶nnen
  php-fpm:
    build:
      context: ../
      dockerfile: php-fpm/Dockerfile.prod
    environment:
      APP_ENV: production
    restart: always
    volumes:
      - "app_data:/var/www/html"
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
    depends_on:
      - db
  # Webserver
  nginx:
    image: nginx:alpine
    volumes:
      - "app_data:/var/www/html"
      - "./nginx/config/default.conf:/etc/nginx/conf.d/default.conf"
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
    ports:
      - "80:80"
    depends_on:
      - php-fpm
    restart: always
  # FÃ¼r die einmalige BefÃ¼llung der Datenbank
  init:
    image: curlimages/curl:8.5.0
    depends_on:
      - php-fpm
      - nginx
    entrypoint: >
      sh -c "
        echo 'â³ Warte auf Nginx...' &&
        until curl -s -o /dev/null -w '%{http_code}' http://nginx/basic | grep -q '200'; do
          sleep 2;
        done &&
        echo 'âœ… Nginx erreichbar, rufe /basic auf...' &&
        curl -s http://nginx/basic &&
        echo 'ğŸ‰ Init fertig'
      "

volumes:
  app_data: